<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Checkout ‚Äì ANEW</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<!-- ‚úÖ EmailJS v4 -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
(function(){
  emailjs.init({
    publicKey: "MQs-22dqHj0Td_9N6"
  });
})();
</script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#F4EDE3;color:#3A2F2A;}
header{background:#E3C6BA;padding:16px 24px;display:flex;justify-content:center;}
header h1{margin:0;font-size:24px;}

/* Sidebar */
.menu-icon{
    font-size:28px;
    cursor:pointer;
    position:fixed;
    top:18px;
    right:18px;
    z-index:1100;
}
.sidebar{
    height:100%;
    width:0;
    position:fixed;
    top:0;
    right:0;
    background:#E3C6BA;
    overflow-x:hidden;
    transition:0.35s;
    padding-top:60px;
    z-index:1200;
    box-shadow:-3px 0 10px rgba(0,0,0,0.15);
}
.sidebar a{
    padding:14px 24px;
    display:block;
    font-size:18px;
    color:#3A2F2A;
    text-decoration:none;
}
.sidebar .closebtn{
    position:absolute;
    top:10px;
    right:20px;
    font-size:32px;
}
.overlay{
    display:none;
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,0.45);
    z-index:1150;
}

/* Checkout */
.container{
    max-width:900px;
    margin:36px auto;
    background:white;
    padding:24px;
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
}
h2{margin-top:0;}
.order-list{margin:12px 0;}
.order-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee;}
.form-row{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;}
input{padding:10px;border-radius:8px;border:1px solid #ccc;width:100%;}
button{margin-top:16px;padding:12px 18px;background:#C69A8D;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
.total{font-weight:bold;text-align:right;margin-top:12px;font-size:18px;}
.note{font-size:13px;color:#6b5a54;margin-top:8px;}
</style>
</head>

<body>

<header>
  <h1>ANEW</h1>
</header>

<!-- Menu icon + Sidebar -->
<div class="menu-icon" onclick="toggleMenu()">‚ò∞</div>
<div id="sidebar" class="sidebar">
  <a href="javascript:void(0)" class="closebtn" onclick="toggleMenu()">&times;</a>
  <a href="index.html">In√≠cio</a>
  <a href="products.html">Produtos</a>
  <a href="cart.html">Carrinho</a>
  <a href="profile.html">Perfil</a>
  <a href="#" onclick="logout()">Logout</a>
</div>
<div id="overlay" class="overlay" onclick="toggleMenu()"></div>

<div class="container">
  <h2>Finalizar Encomenda</h2>

  <div id="orderSection">
    <p>A carregar o teu carrinho‚Ä¶</p>
  </div>

  <form id="checkoutForm" onsubmit="return submitOrder(event)">
    <div class="form-row">
      <div style="flex:1;min-width:200px;">
        <label>Nome</label>
        <input type="text" id="nome" required>
      </div>
      <div style="flex:1;min-width:200px;">
        <label>Email</label>
        <input type="email" id="email" required>
      </div>
    </div>

    <div class="form-row">
      <div style="flex:1;">
        <label>Morada</label>
        <input type="text" id="morada" required>
      </div>
      <div style="width:200px;">
        <label>CP</label>
        <input type="text" id="postcode" required>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label>Telefone</label>
      <input type="text" id="telefone" required>
    </div>

    <div id="orderTotal" class="total">Total: ‚Ç¨0.00</div>

    <button type="submit">Confirmar Encomenda</button>
    <div class="note">Ao confirmar, a encomenda ser√° gravada e o carrinho limpo.</div>
  </form>
</div>

<script>
// EMAIL AUTOM√ÅTICO (SDK v4)
function sendOrderEmail(order, orderId){
  const items = order.items.map(it =>
    `‚Ä¢ ${it.name} (${it.size || ''} ${it.color || ''}) - ‚Ç¨${Number(it.price).toFixed(2)}`
  ).join('\n');

  return emailjs.send(
    "service_b5yk0va",      // MUDA se necess√°rio
    "template_4whemy3",     // MUDA se necess√°rio
    {
      to_email: order.email,   // MUITO IMPORTANTE
      nome: order.nome,
      email: order.email,
      order_id: orderId,
      items: items,
      total: order.total.toFixed(2),
      morada: order.morada,
      postcode: order.postcode,
      telefone: order.telefone
    }
  );
}

// SIDEBAR
function toggleMenu(){
  const s = document.getElementById('sidebar');
  const o = document.getElementById('overlay');
  if(s.style.width === '250px'){ s.style.width='0'; o.style.display='none'; }
  else { s.style.width='250px'; o.style.display='block'; }
}

function logout(){
  auth.signOut().then(()=> window.location='login.html');
}

// FIREBASE & CHECKOUT
let currentUser = null;
let currentCart = [];

auth.onAuthStateChanged(user => {
  currentUser = user;
  if(!currentUser){
    alert('Faz login para finalizar a encomenda!');
    window.location='login.html';
    return;
  }

  document.getElementById('email').value = currentUser.email || '';

  db.collection('users').doc(currentUser.uid).get().then(d=>{
    if(d.exists && d.data().nome) document.getElementById('nome').value = d.data().nome;
  });

  loadCartForCheckout();
});

function loadCartForCheckout(){
  db.collection('carts').doc(currentUser.uid).get().then(doc=>{
    currentCart = doc.exists ? doc.data().items : [];
    renderOrderSection(currentCart);
    updateTotal();
  });
}

function renderOrderSection(cart){
  const el = document.getElementById('orderSection');
  if(!cart.length){
    el.innerHTML = '<p>O carrinho est√° vazio.</p>';
    document.getElementById('checkoutForm').style.display='none';
    return;
  }
  el.innerHTML = cart.map(it=>`
    <div class="order-item">
      <div>${it.name}</div>
      <div>‚Ç¨${Number(it.price).toFixed(2)}</div>
    </div>
  `).join('');
}

function updateTotal(){
  const total = currentCart.reduce((s,it)=> s+Number(it.price||0),0);
  document.getElementById('orderTotal').textContent='Total: ‚Ç¨'+total.toFixed(2);
}

function submitOrder(e){
  e.preventDefault();

  const order = {
    userId: currentUser.uid,
    nome: nome.value.trim(),
    email: email.value.trim(),
    morada: morada.value.trim(),
    postcode: postcode.value.trim(),
    telefone: telefone.value.trim(),
    items: currentCart,
    total: currentCart.reduce((s,it)=> s + Number(it.price || 0), 0),
    createdAt: new Date().toISOString(),
    status: 'pendente'
  };

  db.collection('orders').add(order)
    .then(docRef => sendOrderEmail(order, docRef.id))

    .then(()=> db.collection('carts').doc(currentUser.uid).set({items:[]}))
    .then(()=>{
      alert('Encomenda confirmada! Email enviado üìß');
      window.location='index.html';
    })
    .catch(err=> alert(err.message));
}
</script>

</body>
</html>
